<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Portal</title>
    <link rel="stylesheet" href="style.css">
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üé¨</text></svg>">
    <!-- PWA Stuff -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1e1e">
    <!-- Add HLS.js for m3u8 playback -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>

    <div id="app">
      <div class="container">
        <header>
            <h1>Video Portal</h1>
            <div class="search-container">
                <!-- Hamburger menu removed for simplicity -->
<input type="text" id="searchInput" placeholder="Search videos" v-model="search" @keyup.enter="searchVideos">
<span style="margin-left:1em; color:#42b983">{{ demoMessage }}</span>
<button id="searchButton" @click="searchVideos">Search</button>
<button id="settingsButton" class="settings-button">‚öôÔ∏è</button>
            </div>
        </header>

        <nav id="categoryNav">
            <ul id="categoryList">
  <!-- Rendered by Vue -->
  <li v-for="cat in categories" :key="cat.type_id || cat.id" :class="{ active: selectedCategory === (cat.type_id || cat.id) }" @click="selectCategory(cat.type_id || cat.id)">
    {{ cat.type_name || cat.name }}
  </li>
</ul>
        </nav>

        <main>
            <div v-if="loading" id="loadingIndicator">Loading videos...</div>
<div id="videoGrid">
  <!-- Rendered by Vue -->
  <div v-if="!loading && videos.length === 0">No videos found.</div>
  <div v-for="video in videos" :key="video.vod_id" class="video-card">
    <img :src="getValidImageUrl(video.vod_pic)" :alt="video.vod_name" @error="handleImgError($event)">
    <h3>{{ video.vod_name || 'No Title' }}</h3>
    <p>{{ video.vod_remarks }}</p>
    <!-- Card actions (play/share) will be migrated in a later phase -->
  </div>
</div>
        </main>
    </div>
    <!-- End container -->
    </div>
    <!-- End #app -->

    <!-- Video Detail Modal -->
    <div id="videoDetailModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalDescription">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div class="modal-poster">
                <img id="modalPoster" src="" alt="Video Poster">
            </div>
            <div class="modal-info">
                <h2 id="modalTitle">Video Title</h2>
                <button id="shareButton" class="share-button">Share</button>
                <button id="addToWatchListButton" class="watchlist-button">Add to Watch List</button>
                <p><strong>Year:</strong> <span id="modalYear"></span></p>
                <p><strong>Area:</strong> <span id="modalArea"></span></p>
                <p><strong>Language:</strong> <span id="modalLang"></span></p>
                <p><strong>Director:</strong> <span id="modalDirector"></span></p>
                <p><strong>Actors:</strong> <span id="modalActors"></span></p>
                <p><strong>Status:</strong> <span id="modalRemarks"></span></p>
                <p><strong>Description:</strong></p>
                <div id="modalDescription"></div>
                <br>
                <h4>Episodes/Playback:</h4>
                <div class="modal-episodes">
                    <div id="modalEpisodes">
                        <!-- Episode links will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Video Player Modal (New) -->
    <div id="videoPlayerModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="playingTitle">
        <div class="video-modal-content">
            <span class="close-button">&times;</span>
            <div class="video-player-container">
                <!-- HTML5 video element for HLS.js playback -->
                <video id="videoPlayer" controls preload="auto" style="width:100%; height:100%;"></video>
            </div>
            <div class="video-title-container">
                <h3 id="playingTitle">Now Playing</h3>
            </div>
        </div>
    </div>

    <!-- Share Link Modal -->
    <div id="shareModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="shareModalTitle">
        <div class="modal-content share-modal">
            <span class="close-button">&times;</span>
            <h3 id="shareModalTitle">Share Video</h3>
            <div class="share-content">
                <input type="text" id="shareLink" readonly>
                <button id="copyLinkButton">Copy Link</button>
            </div>
        </div>
    </div>

    <!-- Toast notifications -->
    <div id="toastContainer"></div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsModalTitle">
        <div class="modal-content settings-modal">
            <span class="close-button">&times;</span>
            <h3 id="settingsModalTitle">Settings</h3>
            <div class="settings-form">
                <label for="passwordInput">Enter Password:</label>
                <input type="password" id="passwordInput" placeholder="Password">
                <button id="submitPassword">Submit</button>
                <p id="passwordMessage"></p>
                
<!-- Export/Import All User Data -->
<div class="userdata-import-export" style="margin-top:1rem;">
    <button id="exportAllUserDataButton">Export All Data</button>
    <input type="file" id="importAllUserDataInput" accept=".json" style="display:none;">
    <button id="importAllUserDataButton">Import All Data</button>
</div>
            </div>
        </div>
    </div>

    <!-- Add bottom navigation bar for mobile watch list -->
    <div class="bottom-nav">
        <button id="mobileWatchListButton" class="bottom-nav-button">Watch List</button>
    </div>

    <!-- Vue.js CDN -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="script.js"></script>
    
    <!-- Vue app logic: Phase 1 migration for search, categories, video grid -->
    <script>
      const apiUrl = 'https://api.yzzy-api.com/inc/api_mac10.php';
      const corsProxies = [
        'https://corsproxy.io/?',
        'https://cors.eu.org/',
        'https://thingproxy.freeboard.io/fetch/?url=',
        'https://api.allorigins.win/raw?url=',
        'https://api.allorigins.cf/raw?url=',
        'https://api.allorigins.tk/raw?url=',
        'https://api.codetabs.com/v1/proxy?quest=',
        'https://yacdn.org/proxy/',
        'https://cors.bridged.cc/',
        'https://cors.sho.sh/',
        'https://cors.ironproxy.xyz/',
        'https://norobe-cors-anywhere.herokuapp.com/',
        'https://corsproxy.github.io/?url=',
        'https://cors-proxy.elfsight.com/',
        ''
      ];
      function fetchData(params) {
        // Compose API URL with params
        let url = apiUrl + '?';
        Object.keys(params).forEach(key => {
          url += `${key}=${params[key]}&`;
        });
        url = url.slice(0, -1);
        // Use first proxy for now
        return fetch(corsProxies[0] + encodeURIComponent(url))
          .then(res => res.json())
          .catch(err => { console.error('API fetch error', err); return {}; });
      }
      const { createApp } = Vue;
      createApp({
        data() {
          return {
            search: '',
            demoMessage: 'Welcome to Video Portal with Vue.js!',
            categories: [],
            videos: [],
            selectedCategory: '',
            loading: false
          }
        },
        methods: {
          async fetchCategories() {
            const data = await fetchData({ ac: 'list', pg: 1 });
            if (data && data.class) {
              // Add "All" and "Watch List" manually if needed
              this.categories = [
                { type_id: '', type_name: 'All' },
                ...data.class,
                { id: 'watchlist', name: 'Watch List' }
              ];
              // Set default category
              this.selectedCategory = data.class[0]?.type_id || '';
            }
          },
          async fetchVideos() {
            this.loading = true;
            const params = { ac: 'list', pg: 1 };
            if (this.selectedCategory && this.selectedCategory !== 'watchlist') {
              params.t = this.selectedCategory;
            }
            if (this.search) {
              params.wd = encodeURIComponent(this.search);
            }
            const data = await fetchData(params);
            this.videos = (data && data.list) ? data.list : [];
            this.loading = false;
          },
          selectCategory(catId) {
            this.selectedCategory = catId;
            this.fetchVideos();
          },
          searchVideos() {
            this.fetchVideos();
          },
          getValidImageUrl(imageUrl) {
            // Basic check for valid image URL
            if (!imageUrl) return '';
            if (imageUrl.startsWith('http')) return imageUrl;
            return '';
          },
          handleImgError(e) {
            e.target.src = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22150%22%20height%3D%22225%22%20viewBox%3D%220%200%20150%20225%22%3E%3Crect%20fill%3D%22%23ddd%22%20width%3D%22150%22%20height%3D%22225%22%2F%3E%3Ctext%20fill%3D%22%23666%22%20font-family%3D%22sans-serif%22%20font-size%3D%2216%22%20x%3D%2250%25%22%20y%3D%2250%25%22%20dominant-baseline%3D%22middle%22%20text-anchor%3D%22middle%22%3ENo%20Image%3C%2Ftext%3E%3C%2Fsvg%3E';
          }
        },
        mounted() {
          this.fetchCategories().then(() => {
            this.fetchVideos();
          });
        }
      }).mount('#app');
    </script>
</body>
</html>